{% extends "base.html" %}

{% block title %}Trajet - SGT{% endblock %}

{% block content %}

<h2 class="mb-3">
    {% if form.instance.pk %}Modifier le trajet{% else %}Ajouter un trajet{% endif %}
</h2>

<style>
    #map {
        height: 350px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
</style>

<div class="row">
    <!-- ğŸ“ Ø§Ù„ÙÙˆØ±Ù… ÙƒÙ…Ø§ ÙƒØ§Ù† ÙÙŠ ÙƒØ§Ø±Øª -->
    <div class="col-md-5">
        <form method="post" class="card p-3 mb-3">
            {% csrf_token %}

            <!-- Ville de dÃ©part -->
            <div class="mb-3">
                <label class="form-label">Ville de dÃ©part</label>
                <select id="id_ville_depart" name="ville_depart" class="form-select" required>
                    <option value="">-- Choisir la ville de dÃ©part --</option>

                    <optgroup label="Wilaya de Nouakchott">
                        <option value="Nouakchott">Nouakchott</option>
                    </optgroup>

                    <optgroup label="Wilaya de Dakhlet Nouadhibou">
                        <option value="Nouadhibou">Nouadhibou</option>
                    </optgroup>

                    <optgroup label="Wilaya de Trarza">
                        <option value="Rosso">Rosso</option>
                        <option value="BoghÃ©">BoghÃ©</option>
                    </optgroup>

                    <optgroup label="Wilaya du Brakna">
                        <option value="Aleg">Aleg</option>
                        <option value="Boutilimit">Boutilimit</option>
                    </optgroup>

                    <optgroup label="Wilaya du Gorgol">
                        <option value="KaÃ©di">KaÃ©di</option>
                    </optgroup>

                    <optgroup label="Wilaya du Guidimakha">
                        <option value="SÃ©libaby">SÃ©libaby</option>
                    </optgroup>

                    <optgroup label="Wilaya de lâ€™Assaba">
                        <option value="Kiffa">Kiffa</option>
                    </optgroup>

                    <optgroup label="Wilaya du Hodh El Gharbi">
                        <option value="AÃ¯oun el Atrouss">AÃ¯oun el Atrouss</option>
                    </optgroup>

                    <optgroup label="Wilaya du Hodh Ech Chargui">
                        <option value="NÃ©ma">NÃ©ma</option>
                    </optgroup>

                    <optgroup label="Wilaya de Tagant">
                        <option value="Tidjikja">Tidjikja</option>
                    </optgroup>

                    <optgroup label="Wilaya de lâ€™Adrar">
                        <option value="Atar">Atar</option>
                    </optgroup>

                    <optgroup label="Wilaya de lâ€™Inchiri">
                        <option value="Akjoujt">Akjoujt</option>
                    </optgroup>

                    <optgroup label="Wilaya de Tiris Zemmour">
                        <option value="Zouerate">Zouerate</option>
                    </optgroup>
                </select>
            </div>

            <!-- Ville dâ€™arrivÃ©e -->
            <div class="mb-3">
                <label class="form-label">Ville dâ€™arrivÃ©e</label>
                <select id="id_ville_arrivee" name="ville_arrivee" class="form-select" required>
                    <option value="">-- Choisir la ville dâ€™arrivÃ©e --</option>

                    <optgroup label="Wilaya de Nouakchott">
                        <option value="Nouakchott">Nouakchott</option>
                    </optgroup>

                    <optgroup label="Wilaya de Dakhlet Nouadhibou">
                        <option value="Nouadhibou">Nouadhibou</option>
                    </optgroup>

                    <optgroup label="Wilaya de Trarza">
                        <option value="Rosso">Rosso</option>
                        <option value="BoghÃ©">BoghÃ©</option>
                    </optgroup>

                    <optgroup label="Wilaya du Brakna">
                        <option value="Aleg">Aleg</option>
                        <option value="Boutilimit">Boutilimit</option>
                    </optgroup>

                    <optgroup label="Wilaya du Gorgol">
                        <option value="KaÃ©di">KaÃ©di</option>
                    </optgroup>

                    <optgroup label="Wilaya du Guidimakha">
                        <option value="SÃ©libaby">SÃ©libaby</option>
                    </optgroup>

                    <optgroup label="Wilaya de lâ€™Assaba">
                        <option value="Kiffa">Kiffa</option>
                    </optgroup>

                    <optgroup label="Wilaya du Hodh El Gharbi">
                        <option value="AÃ¯oun el Atrouss">AÃ¯oun el Atrouss</option>
                    </optgroup>

                    <optgroup label="Wilaya du Hodh Ech Chargui">
                        <option value="NÃ©ma">NÃ©ma</option>
                    </optgroup>

                    <optgroup label="Wilaya de Tagant">
                        <option value="Tidjikja">Tidjikja</option>
                    </optgroup>

                    <optgroup label="Wilaya de lâ€™Adrar">
                        <option value="Atar">Atar</option>
                    </optgroup>

                    <optgroup label="Wilaya de lâ€™Inchiri">
                        <option value="Akjoujt">Akjoujt</option>
                    </optgroup>

                    <optgroup label="Wilaya de Tiris Zemmour">
                        <option value="Zouerate">Zouerate</option>
                    </optgroup>
                </select>
            </div>

            <!-- Distance (km) â€“ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… -->
            <div class="mb-3">
                <label class="form-label">Distance (km)</label>
                {{ form.distance_km }}
            </div>

            <!-- DurÃ©e prÃ©vue â€“ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… -->
            <div class="mb-3">
                <label class="form-label">DurÃ©e prÃ©vue (hh:mm:ss)</label>
                {{ form.duree_prevue }}
            </div>

            <button type="submit" class="btn btn-primary">Enregistrer</button>
            <a href="{% url 'liste_trajets' %}" class="btn btn-secondary">Annuler</a>
        </form>
    </div>

    <!-- ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„ÙƒÙ† Ø®Ø§Ø±Ø¬ Ø§Ù„ÙÙˆØ±Ù… (Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©) -->
    <div class="col-md-7">
        <div class="card p-3">
            <h5>Carte du trajet</h5>
            <p class="text-muted mb-2">
                Le systÃ¨me trace lâ€™itinÃ©raire routier entre les deux villes et calcule
                automatiquement la distance et la durÃ©e (vitesse 90 km/h).
            </p>
            <div id="map"></div>
        </div>
    </div>
</div>

<!-- Leaflet CSS (Ù…Ø³Ù…ÙˆØ­ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ùˆ Ø£ÙØ¶Ù„ ÙÙŠ <head>) -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>

<link rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ø¹ÙˆØ§ØµÙ… Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§
    const cityCoords = {
        "Nouakchott":         {lat: 18.0735, lng: -15.9582},
        "Nouadhibou":         {lat: 20.9025, lng: -17.0347},
        "Rosso":              {lat: 16.5133, lng: -15.8053},
        "BoghÃ©":              {lat: 16.5900, lng: -14.2600},
        "Aleg":               {lat: 17.0500, lng: -13.9100},
        "Boutilimit":         {lat: 17.5500, lng: -14.6833},
        "KaÃ©di":              {lat: 16.1500, lng: -13.5000},
        "SÃ©libaby":           {lat: 15.1580, lng: -12.1840},
        "Kiffa":              {lat: 16.6200, lng: -11.4000},
        "AÃ¯oun el Atrouss":   {lat: 16.6667, lng: -9.6167},
        "NÃ©ma":               {lat: 16.6170, lng: -7.2570},
        "Tidjikja":           {lat: 18.5560, lng: -11.4270},
        "Atar":               {lat: 20.5169, lng: -13.0490},
        "Akjoujt":            {lat: 19.7466, lng: -14.3853},
        "Zouerate":           {lat: 22.7333, lng: -12.4667}
    };

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ ÙˆØ³Ø· Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
    let map = L.map('map').setView([18.0, -13.0], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let routingControl = null;

    function updateRoute() {
        const departSelect  = document.getElementById("id_ville_depart");
        const arriveeSelect = document.getElementById("id_ville_arrivee");

        const departCity  = departSelect.value;
        const arriveeCity = arriveeSelect.value;

        if (!departCity || !arriveeCity ||
            !cityCoords[departCity] || !cityCoords[arriveeCity]) {
            return;
        }

        const dCoords = cityCoords[departCity];
        const aCoords = cityCoords[arriveeCity];

        const departLatLng  = L.latLng(dCoords.lat, dCoords.lng);
        const arriveeLatLng = L.latLng(aCoords.lat, aCoords.lng);

        if (routingControl) {
            routingControl.setWaypoints([departLatLng, arriveeLatLng]);
        } else {
            routingControl = L.Routing.control({
                waypoints: [departLatLng, arriveeLatLng],
                draggableWaypoints: false,
                addWaypoints: false,
                routeWhileDragging: false,
                show: false,
                lineOptions: {
                    addWaypoints: false
                },
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                })
            })
            .on('routesfound', function(e) {
                const route = e.routes[0];

                // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„Ù…ØªØ± â†’ Ù†Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ÙƒÙŠÙ„ÙˆÙ…ØªØ±
                const distanceMeters = route.summary.totalDistance;
                const distanceKm = distanceMeters / 1000.0;
                const distanceRounded = distanceKm.toFixed(2);

                const distanceField = document.getElementById("id_distance_km");
                if (distanceField) {
                    distanceField.value = distanceRounded;
                }

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø¨Ø³Ø±Ø¹Ø© 90 ÙƒÙ…/Ø³Ø§Ø¹Ø©
                const speed = 90.0;  // km/h
                const hours = distanceKm / speed;
                const totalMinutes = Math.round(hours * 60);
                const hh = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
                const mm = String(totalMinutes % 60).padStart(2, '0');
                const dureeStr = hh + ":" + mm + ":00";

                const dureeField = document.getElementById("id_duree_prevue");
                if (dureeField) {
                    dureeField.value = dureeStr;
                }
            })
            .addTo(map);
        }

        // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±
        const bounds = L.latLngBounds(departLatLng, arriveeLatLng);
        map.fitBounds(bounds, {padding: [30, 30]});
    }

    document.addEventListener("DOMContentLoaded", function () {
        const departSelect  = document.getElementById("id_ville_depart");
        const arriveeSelect = document.getElementById("id_ville_arrivee");

        if (departSelect) {
            departSelect.addEventListener("change", updateRoute);
        }
        if (arriveeSelect) {
            arriveeSelect.addEventListener("change", updateRoute);
        }

        // Ø¥Ø°Ø§ ÙƒÙ†Øª ÙÙŠ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ ÙˆÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ù‚ÙŠÙ… Ù…Ø­ÙÙˆØ¸Ø© ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ·ÙˆÙŠØ±
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ© Ù…Ù† form.instance.ville_depart / ville_arrivee ÙÙŠ Ø§Ù„Ù€ JS
    });
</script>

{% endblock %}
