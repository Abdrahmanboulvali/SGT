{% extends "base.html" %}

{% block title %}Nouvelle réservation - SGT{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold m-0">
    <i class="bi bi-ticket-perforated text-primary"></i>
    Nouvelle réservation
  </h2>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body p-0">

    <div class="bg-primary text-white px-4 py-3 rounded-top">
      <i class="bi bi-plus-circle"></i>
      Création d'une réservation
    </div>

    <div class="p-4">

      <!-- ✅ Errors -->
      {% if form.errors %}
        <div class="alert alert-danger shadow-sm">
          <div class="fw-bold mb-2">
            <i class="bi bi-exclamation-triangle-fill"></i>
            Erreurs dans le formulaire :
          </div>

          <ul class="mb-0">
            {% for err in form.non_field_errors %}
              <li>{{ err }}</li>
            {% endfor %}

            {% for field in form %}
              {% for err in field.errors %}
                <li><b>{{ field.label }}:</b> {{ err }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <form method="POST" novalidate>
        {% csrf_token %}

        <!-- ✅ Client Section -->
        <div class="row g-3 align-items-end">

          <div class="col-lg-4">
            <label class="form-label fw-bold">Type client</label>
            {{ form.client_mode }}
            <small class="text-muted d-block mt-1">
              Choisissez client existant ou Autre.
            </small>
          </div>

          <div class="col-lg-8" id="existingClientBlock">
            <label class="form-label fw-bold">Client</label>
            {{ form.client }}
            <small class="text-muted d-block mt-1">
              Cherchez le Zayoun à l'intérieur de la boite.
            </small>
          </div>

        </div>

        <!-- ✅ New client fields -->
        <div class="row g-3 mt-2" id="otherClientBlock" style="display:none;">
          <div class="col-lg-6">
            <label class="form-label fw-bold">Nom du client</label>
            {{ form.autre_nom }}
          </div>

          <div class="col-lg-6">
            <label class="form-label fw-bold">Téléphone</label>
            {{ form.autre_tel }}
          </div>
        </div>

        <hr class="my-4">

        <!-- ✅ Reservation fields -->
        <div class="row g-3 align-items-end">

          <div class="col-lg-6">
            <label class="form-label fw-bold">Voyage</label>
            {{ form.voyage }}
            <small class="text-muted d-block mt-1">
              Choisissez un voyage pour enregistrer la réservation.
            </small>
          </div>

          <div class="col-lg-3">
            <label class="form-label fw-bold">Nb sièges</label>
            {{ form.nb_sieges }}
          </div>

          <div class="col-lg-3">
            <label class="form-label fw-bold">Méthode de paiement</label>
            {{ form.mode_paiement }}
          </div>

        </div>

        <!-- ✅ Buttons -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <a href="{% url 'liste_reservations' %}" class="btn btn-light px-4">
            Annuler
          </a>

          <button type="submit" class="btn btn-primary px-4 shadow-sm">
            <i class="bi bi-check-circle"></i>
            Confirmer la réservation
          </button>
        </div>

      </form>

    </div>
  </div>
</div>


<!-- ✅ jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- ✅ Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  (function () {

    function isOtherMode(val) {
      val = (val || "").toLowerCase().trim();
      return (val === "other" || val.includes("autre"));
    }

    function toggleClientMode() {
      const modeEl = document.getElementById("id_client_mode");
      if (!modeEl) return;

      const other = isOtherMode(modeEl.value);

      const existingBlock = document.getElementById("existingClientBlock");
      const otherBlock = document.getElementById("otherClientBlock");

      const clientSelect = document.getElementById("id_client");
      const autreNom = document.getElementById("id_autre_nom");
      const autreTel = document.getElementById("id_autre_tel");

      if (other) {
        // ✅ Hide existing client select
        if (existingBlock) existingBlock.style.display = "none";

        // ✅ Show other fields (row bootstrap => flex)
        if (otherBlock) otherBlock.style.display = "flex";

        // ✅ Disable client select so it won't be required
        if (clientSelect) {
          clientSelect.value = "";
          clientSelect.disabled = true;
        }

        // ✅ Make other fields required
        if (autreNom) autreNom.required = true;
        if (autreTel) autreTel.required = true;

      } else {
        // ✅ Show existing client select
        if (existingBlock) existingBlock.style.display = "block";

        // ✅ Hide other fields
        if (otherBlock) otherBlock.style.display = "none";

        // ✅ Enable client select
        if (clientSelect) {
          clientSelect.disabled = false;
        }

        // ✅ Clear other fields & remove required
        if (autreNom) { autreNom.required = false; autreNom.value = ""; }
        if (autreTel) { autreTel.required = false; autreTel.value = ""; }
      }
    }

    // ✅ Run on load + on change
    document.addEventListener("DOMContentLoaded", function () {
      toggleClientMode();

      const modeEl = document.getElementById("id_client_mode");
      if (modeEl) modeEl.addEventListener("change", toggleClientMode);
    });

  })();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window.jQuery && $("#id_client").length && $.fn.select2) {
      $("#id_client").select2({
        placeholder: "— Sélectionner un client —",
        allowClear: true,
        width: "100%"
      });
    }
  });
</script>


{% endblock %}
