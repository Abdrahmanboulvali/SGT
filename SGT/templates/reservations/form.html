{% extends "base.html" %}

{% block title %}Nouvelle réservation - SGT{% endblock %}

{% block content %}

<style>
  /* ===============================
     NEW RESERVATION • PREMIUM FORM ✅
     (No logic change, only UI)
     =============================== */

  .form-wrap{
    max-width: 980px;
    margin: 0 auto;
  }

  .page-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }

  .page-title{
    display:flex;
    align-items:center;
    gap: 10px;
    margin:0;
    font-weight: 950;
    letter-spacing: -.6px;
    color:#0f172a;
  }

  .page-title i{
    width: 44px;
    height: 44px;
    display:grid;
    place-items:center;
    border-radius: 14px;
    background: rgba(37,99,235,.10);
    border: 1px solid rgba(37,99,235,.18);
    color:#2563eb;
    font-size: 1.25rem;
  }

  .form-card{
    border: 1px solid rgba(15,23,42,.10) !important;
    border-radius: 18px !important;
    overflow: hidden !important;
    background:#fff !important;
    box-shadow: 0 18px 40px rgba(15,23,42,.10) !important;
  }

  .form-card-header{
    background: linear-gradient(135deg, #2563eb, #06b6d4);
    color:#fff;
    padding: 16px 18px;
    font-weight: 900;
    display:flex;
    align-items:center;
    gap: 10px;
  }

  .form-card-header i{
    width: 38px;
    height: 38px;
    display:grid;
    place-items:center;
    border-radius: 14px;
    background: rgba(255,255,255,.18);
    border: 1px solid rgba(255,255,255,.22);
  }

  .form-inner{
    padding: 18px 18px 20px;
  }

  .section{
    background:#ffffff;
    border: 1px solid #e6eef9;
    border-radius: 18px;
    padding: 16px 16px;
    margin-bottom: 14px;
  }

  .section-title{
    display:flex;
    align-items:center;
    gap:10px;
    margin:0 0 12px 0;
    font-weight: 950;
    color:#0f172a;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6eef9;
  }

  .section-title i{
    color:#2563eb;
    font-size: 1.1rem;
  }

  .help-text{
    color:#64748b;
    font-size: .88rem;
    font-weight: 600;
    margin-top: 6px;
  }

  /* Make inputs nicer (works with Django widgets) */
  .form-wrap input,
  .form-wrap select,
  .form-wrap textarea{
    border-radius: 12px !important;
  }

  /* Select2 styling */
  .select2-container .select2-selection--single{
    height: 44px !important;
    border-radius: 12px !important;
    border: 1px solid #dbe7f6 !important;
    display:flex !important;
    align-items:center !important;
    padding: 0 10px !important;
  }
  .select2-container .select2-selection__rendered{
    line-height: 42px !important;
    font-weight: 700;
    color:#0f172a;
  }
  .select2-container .select2-selection__arrow{
    height: 44px !important;
  }
  .select2-dropdown{
    border-radius: 12px !important;
    border: 1px solid #dbe7f6 !important;
    overflow:hidden;
  }
  .select2-search__field{
    border-radius: 12px !important;
    border: 1px solid #dbe7f6 !important;
  }

  .actions-bar{
    display:flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 14px;
  }

  .btn-light{
    border: 1px solid #dbe7f6 !important;
    background: #ffffff !important;
  }

  /* Errors */
  .error-box{
    border-radius: 16px;
    border: 1px solid rgba(239,68,68,.25);
    background: rgba(239,68,68,.06);
    padding: 14px 14px;
    box-shadow: 0 10px 20px rgba(15,23,42,.06);
  }

</style>

<div class="form-wrap">

  <!-- Header -->
  <div class="page-head">
    <h2 class="page-title">
      <i class="bi bi-ticket-perforated"></i>
      Nouvelle réservation
    </h2>
  </div>

  <div class="form-card">

    <div class="form-card-header">
      <i class="bi bi-plus-circle"></i>
      <span>Création d'une réservation</span>
    </div>

    <div class="form-inner">

      <!-- ✅ Errors -->
      {% if form.errors %}
        <div class="error-box mb-3">
          <div class="fw-bold mb-2">
            <i class="bi bi-exclamation-triangle-fill"></i>
            Erreurs dans le formulaire :
          </div>

          <ul class="mb-0">
            {% for err in form.non_field_errors %}
              <li>{{ err }}</li>
            {% endfor %}

            {% for field in form %}
              {% for err in field.errors %}
                <li><b>{{ field.label }}:</b> {{ err }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <form method="POST" novalidate>
        {% csrf_token %}

        <!-- =======================
             SECTION 1 • CLIENT ✅
             ======================= -->
        <div class="section">
          <h5 class="section-title">
            <i class="bi bi-person-check"></i>
            Informations client
          </h5>

          <div class="row g-3 align-items-end">

            <div class="col-lg-4">
              <label class="form-label fw-bold">Type client</label>
              {{ form.client_mode }}
              <div class="help-text">
                Choisissez un client existant ou <b>Autre</b>.
              </div>
            </div>

            <div class="col-lg-8" id="existingClientBlock">
              <label class="form-label fw-bold">Client</label>
              {{ form.client }}
              <div class="help-text">
                Cherchez le client داخل القائمة.
              </div>
            </div>

          </div>

          <!-- Other client -->
          <div class="row g-3 mt-2" id="otherClientBlock" style="display:none;">
            <div class="col-lg-6">
              <label class="form-label fw-bold">Nom du client</label>
              {{ form.autre_nom }}
            </div>

            <div class="col-lg-6">
              <label class="form-label fw-bold">Téléphone</label>
              {{ form.autre_tel }}
            </div>
          </div>
        </div>

        <!-- =======================
             SECTION 2 • RESERVATION ✅
             ======================= -->
        <div class="section">
          <h5 class="section-title">
            <i class="bi bi-calendar2-check"></i>
            Détails de la réservation
          </h5>

          <div class="row g-3 align-items-end">

            <div class="col-lg-6">
              <label class="form-label fw-bold">Voyage</label>
              {{ form.voyage }}
              <div class="help-text">
                Choisissez un voyage disponible.
              </div>
            </div>

            <div class="col-lg-3">
              <label class="form-label fw-bold">Nb sièges</label>
              {{ form.nb_sieges }}
            </div>

            <div class="col-lg-3">
              <label class="form-label fw-bold">Méthode de paiement</label>
              {{ form.mode_paiement }}
            </div>

          </div>
        </div>

        <!-- =======================
             ACTIONS ✅
             ======================= -->
        <div class="actions-bar">
          <a href="{% url 'liste_reservations' %}" class="btn btn-light px-4">
            Annuler
          </a>

          <button type="submit" class="btn btn-primary px-4 shadow-sm">
            <i class="bi bi-check-circle"></i>
            Confirmer la réservation
          </button>
        </div>

      </form>

    </div>
  </div>

</div>

<!-- ✅ jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- ✅ Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  (function () {

    function isOtherMode(val) {
      val = (val || "").toLowerCase().trim();
      return (val === "other" || val.includes("autre"));
    }

    function toggleClientMode() {
      const modeEl = document.getElementById("id_client_mode");
      if (!modeEl) return;

      const other = isOtherMode(modeEl.value);

      const existingBlock = document.getElementById("existingClientBlock");
      const otherBlock = document.getElementById("otherClientBlock");

      const clientSelect = document.getElementById("id_client");
      const autreNom = document.getElementById("id_autre_nom");
      const autreTel = document.getElementById("id_autre_tel");

      if (other) {
        if (existingBlock) existingBlock.style.display = "none";
        if (otherBlock) otherBlock.style.display = "flex";

        if (clientSelect) {
          clientSelect.value = "";
          clientSelect.disabled = true;
        }

        if (autreNom) autreNom.required = true;
        if (autreTel) autreTel.required = true;

      } else {
        if (existingBlock) existingBlock.style.display = "block";
        if (otherBlock) otherBlock.style.display = "none";

        if (clientSelect) {
          clientSelect.disabled = false;
        }

        if (autreNom) { autreNom.required = false; autreNom.value = ""; }
        if (autreTel) { autreTel.required = false; autreTel.value = ""; }
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      toggleClientMode();

      const modeEl = document.getElementById("id_client_mode");
      if (modeEl) modeEl.addEventListener("change", toggleClientMode);
    });

  })();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window.jQuery && $("#id_client").length && $.fn.select2) {
      $("#id_client").select2({
        placeholder: "— Sélectionner un client —",
        allowClear: true,
        width: "100%"
      });
    }
  });
</script>

{% endblock %}
